<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilih Toko - Dashboard Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .glassmorphism {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .dropdown {
            position: relative;
            min-width: 400px;
        }
        
        .dropdown-button {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .dropdown-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
            transform: translateY(-10px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .dropdown-menu.show {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        
        .dropdown-item {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .dropdown-item:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateX(5px);
        }
        
        .store-stats {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Memuat data toko...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
                <i class="fas fa-chart-line mr-3"></i>
                Dashboard Analytics
            </h1>
            <p class="text-xl text-white/80 mb-8">Pilih toko untuk melihat analisa bisnis</p>
        </div>

        <!-- Store Selection Dropdown -->
        <div class="flex justify-center">
            <div class="dropdown">
                <!-- Dropdown Button -->
                <div id="dropdownButton" class="dropdown-button glassmorphism rounded-2xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-store text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold" id="selectedStoreName">Pilih Toko</h3>
                                <p class="text-sm opacity-75" id="selectedStoreInfo">Klik untuk memilih toko</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-chevron-down text-xl transition-transform duration-300" id="dropdownIcon"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Dropdown Menu -->
                <div id="dropdownMenu" class="dropdown-menu mt-2">
                    <div class="p-2">
                        <div class="text-gray-600 text-sm font-medium px-4 py-2 border-b border-gray-200 mb-2">
                            <i class="fas fa-store mr-2"></i>
                            Pilih Toko untuk Dashboard
                        </div>
                        <div id="storeList">
                            <!-- Store options will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-40">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span id="errorText">Terjadi kesalahan</span>
            <button onclick="hideError()" class="ml-3 text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <script>
        class StoreSelector {
            constructor() {
                // Supabase configuration
                this.supabaseUrl = 'https://ykoemhbgswbwskhrvezq.supabase.co';
                this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlrb2VtaGJnc3did3NraHJ2ZXpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4MDc2NjUsImV4cCI6MjA2NzM4MzY2NX0.GRlz8yO6I_NVKt6PrNpd-iEblRNqswNDr5wDR93e-Hk';
                
                // Initialize Supabase client
                this.supabase = supabase.createClient(this.supabaseUrl, this.supabaseKey);
                
                this.stores = [];
                this.init();
            }

            async init() {
                try {
                    await this.loadStores();
                    this.setupDropdown();
                    this.renderStores();
                    this.hideLoadingScreen();
                } catch (error) {
                    console.error('Error initializing store selector:', error);
                    this.showError('Gagal memuat data toko. Periksa koneksi internet.');
                    this.hideLoadingScreen();
                }
            }

            setupDropdown() {
                const dropdownButton = document.getElementById('dropdownButton');
                const dropdownMenu = document.getElementById('dropdownMenu');
                const dropdownIcon = document.getElementById('dropdownIcon');

                // Toggle dropdown on button click
                dropdownButton.addEventListener('click', () => {
                    const isOpen = dropdownMenu.classList.contains('show');
                    
                    if (isOpen) {
                        this.closeDropdown();
                    } else {
                        this.openDropdown();
                    }
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!dropdownButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
                        this.closeDropdown();
                    }
                });

                // Close dropdown on escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeDropdown();
                    }
                });
            }

            openDropdown() {
                const dropdownMenu = document.getElementById('dropdownMenu');
                const dropdownIcon = document.getElementById('dropdownIcon');
                
                dropdownMenu.classList.add('show');
                dropdownIcon.style.transform = 'rotate(180deg)';
            }

            closeDropdown() {
                const dropdownMenu = document.getElementById('dropdownMenu');
                const dropdownIcon = document.getElementById('dropdownIcon');
                
                dropdownMenu.classList.remove('show');
                dropdownIcon.style.transform = 'rotate(0deg)';
            }

            async loadStores() {
                try {
                    // Fetch all stores from database
                    const { data: stores, error } = await this.supabase
                        .from('toko')
                        .select('*')
                        .order('nama_toko');

                    if (error) throw error;

                    // Get transaction stats for each store
                    const storesWithStats = await Promise.all(
                        stores.map(async (store) => {
                            const stats = await this.getStoreStats(store.id);
                            return {
                                ...store,
                                stats
                            };
                        })
                    );

                    this.stores = storesWithStats;
                    console.log('Stores loaded:', this.stores);
                } catch (error) {
                    console.error('Error loading stores:', error);
                    throw error;
                }
            }

            async getStoreStats(storeId) {
                try {
                    // Get recent transactions for this store
                    const { data: transactions, error } = await this.supabase
                        .from('transaksi')
                        .select('total, created_at')
                        .eq('toko_id', storeId)
                        .gte('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString())
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    const totalRevenue = transactions.reduce((sum, t) => sum + (t.total || 0), 0);
                    const totalTransactions = transactions.length;
                    const avgTransaction = totalTransactions > 0 ? totalRevenue / totalTransactions : 0;

                    // Get today's data
                    const today = new Date().toISOString().split('T')[0];
                    const todayTransactions = transactions.filter(t => 
                        t.created_at.startsWith(today)
                    );
                    const todayRevenue = todayTransactions.reduce((sum, t) => sum + (t.total || 0), 0);

                    return {
                        totalRevenue,
                        totalTransactions,
                        avgTransaction,
                        todayRevenue,
                        todayTransactions: todayTransactions.length
                    };
                } catch (error) {
                    console.error('Error getting store stats:', error);
                    return {
                        totalRevenue: 0,
                        totalTransactions: 0,
                        avgTransaction: 0,
                        todayRevenue: 0,
                        todayTransactions: 0
                    };
                }
            }

            renderStores() {
                const storeList = document.getElementById('storeList');
                
                if (this.stores.length === 0) {
                    storeList.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-store text-4xl text-gray-400 mb-3"></i>
                            <h3 class="text-lg font-bold text-gray-700 mb-2">Tidak ada toko ditemukan</h3>
                            <p class="text-gray-500 text-sm">Pastikan database sudah terisi dengan data toko</p>
                        </div>
                    `;
                    return;
                }

                storeList.innerHTML = this.stores.map(store => `
                    <div class="dropdown-item p-4 rounded-xl m-1" 
                         onclick="selectStore('${store.id}', '${store.nama_toko}')">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-store text-blue-600"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">${store.nama_toko}</h4>
                                <p class="text-sm text-gray-500">${store.alamat || 'Alamat tidak tersedia'}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            formatCurrencyShort(amount) {
                if (amount >= 1000000) {
                    return `${(amount / 1000000).toFixed(1)}M`;
                } else if (amount >= 1000) {
                    return `${(amount / 1000).toFixed(0)}K`;
                }
                return this.formatCurrency(amount);
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount || 0);
            }

            hideLoadingScreen() {
                const loadingScreen = document.getElementById('loadingScreen');
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 300);
            }

            showError(message) {
                const errorMessage = document.getElementById('errorMessage');
                const errorText = document.getElementById('errorText');
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
                
                // Auto hide after 5 seconds
                setTimeout(() => {
                    this.hideError();
                }, 5000);
            }

            hideError() {
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.classList.add('hidden');
            }
        }

        // Global functions
        function selectStore(storeId, storeName) {
            // Update dropdown button to show selected store
            updateSelectedStore(storeName);
            
            // Close dropdown
            window.storeSelector.closeDropdown();
            
            // Store the selected store data in localStorage
            localStorage.setItem('selectedStoreId', storeId);
            localStorage.setItem('selectedStoreName', storeName);
            
            // Show confirmation and redirect after delay
            setTimeout(() => {
                // Show loading state
                document.body.innerHTML = `
                    <div class="fixed inset-0 gradient-bg flex items-center justify-center">
                        <div class="text-center">
                            <div class="loading-spinner mx-auto mb-4"></div>
                            <h3 class="text-xl font-bold text-white mb-2">Memuat Dashboard</h3>
                            <p class="text-white/70">Mengambil data untuk ${storeName}...</p>
                        </div>
                    </div>
                `;
                
                // Redirect to dashboard after short delay
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            }, 800);
        }

        function updateSelectedStore(storeName) {
            const selectedStoreName = document.getElementById('selectedStoreName');
            const selectedStoreInfo = document.getElementById('selectedStoreInfo');
            
            if (selectedStoreName) {
                selectedStoreName.textContent = storeName;
            }
            
            if (selectedStoreInfo) {
                selectedStoreInfo.textContent = 'Toko dipilih - Klik untuk dashboard';
            }
        }

        function hideError() {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.classList.add('hidden');
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.storeSelector = new StoreSelector();
        });
    </script>
</body>
</html>
